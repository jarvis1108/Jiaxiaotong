package com.dxtwangxiao.strongestsuperscholar.web.controller.system;

import com.alibaba.fastjson.JSONObject;
import com.dxtwangxiao.strongestsuperscholar.module.system.service.UserService;
import com.dxtwangxiao.strongestsuperscholar.module.wechat.entity.WechatToken;
import com.dxtwangxiao.strongestsuperscholar.module.wechat.service.WechatService;
import com.dxtwangxiao.strongestsuperscholar.web.dto.UserDTO;
import com.dxtwangxiao.strongestsuperscholar.web.error.CommonError;
import com.dxtwangxiao.strongestsuperscholar.web.error.StrongestScholarException;
import com.dxtwangxiao.strongestsuperscholar.web.util.WebUtil;
import com.dxtwangxiao.strongestsuperscholar.web.vo.RequestInfo;
import com.dxtwangxiao.strongestsuperscholar.web.vo.ResponseInfo;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import javax.servlet.http.HttpServletRequest;

/**
 * 用户控制器
 * <p>
 * Created by Devin
 * 2018-06-29 上午 10:48
 */
@RestController
@RequestMapping("/api/v1/sys/user")
public class UserController {

    @Autowired
    private UserService userService;

    @Autowired
    private WechatService wechatService;

    /**
     * 根据用户id获取用户信息
     *
     * @param userId  用户id
     * @param request http请求
     * @return
     */
    @GetMapping("/{userId}")
    public ResponseInfo getUserInfo(@PathVariable("userId") String userId, HttpServletRequest request) {
        RequestInfo requestInfo = WebUtil.parseRequest(request);
        JSONObject jsonObject = new JSONObject();
        UserDTO userDTO = userService.getUserDTOById(userId);
        jsonObject.put("user", userDTO);
        return new ResponseInfo(requestInfo, jsonObject);
    }

    /**
     * 通过code获取用户信息
     *
     * @param request http请求
     * @return
     * @throws StrongestScholarException
     */
    @GetMapping("/code")
    public ResponseInfo getUserInfoByCode(HttpServletRequest request) throws StrongestScholarException {
        RequestInfo requestInfo = WebUtil.parseRequest(request);
        JSONObject reqParam = requestInfo.getReqParam();
        String code = reqParam.getString("code");

        WechatToken wechatToken = wechatService.getTokenByCode(code);
        if (wechatToken == null || wechatToken.getOpenid() == null) {
            throw new StrongestScholarException(CommonError.WECHAT_CODE_ERROR.getCode(), CommonError.WECHAT_CODE_ERROR.getMessage());
        }
        JSONObject jsonObject = new JSONObject();
        UserDTO userDTO = userService.getUserDTOByOpenid(wechatToken.getOpenid());
        if (userDTO == null) {
            throw new StrongestScholarException(CommonError.USER_NOT_EXIST.getCode(), CommonError.USER_NOT_EXIST.getMessage());
        }
        jsonObject.put("user", userDTO);
        return new ResponseInfo(requestInfo, jsonObject);
    }

    /**
     * 根据用户code获取openid，保存到数据库
     *
     * @param requestInfo 请求信息
     * @return
     * @throws StrongestScholarException
     */
    @PostMapping("/code")
    public ResponseInfo saveUserOpenid(@RequestBody RequestInfo requestInfo) throws StrongestScholarException {
        JSONObject reqParam = requestInfo.getReqParam();
        String code = reqParam.getString("code");
        String userId = reqParam.getString("userId");

        WechatToken wechatToken = wechatService.getTokenByCode(code);
        if (wechatToken == null || wechatToken.getOpenid() == null) {
            throw new StrongestScholarException(CommonError.WECHAT_CODE_ERROR.getCode(), CommonError.WECHAT_CODE_ERROR.getMessage());
        }
        userService.saveUserOpenid(userId, wechatToken.getOpenid());
        JSONObject jsonObject = new JSONObject();
        return new ResponseInfo(requestInfo, jsonObject);
    }

    /**
     * 微信小程序，创建新用户
     *
     * @param requestInfo 请求信息
     * @return
     */
    @PostMapping
    public ResponseInfo createNewUser(@RequestBody RequestInfo requestInfo) {
        JSONObject reqParam = requestInfo.getReqParam();
        String nickName = reqParam.getString("nickName");
        String avatarUrl = reqParam.getString("avatarUrl");
        String gender = reqParam.getString("gender");
        String city = reqParam.getString("city");
        String gradePhaseId = reqParam.getString("gradePhaseId");
        String gradeId = reqParam.getString("gradeId");

        JSONObject jsonObject = new JSONObject();
        UserDTO userDTO = userService.createUser(nickName, avatarUrl, gender, city, gradePhaseId, gradeId);
        jsonObject.put("user", userDTO);
        return new ResponseInfo(requestInfo, jsonObject);
    }
}
