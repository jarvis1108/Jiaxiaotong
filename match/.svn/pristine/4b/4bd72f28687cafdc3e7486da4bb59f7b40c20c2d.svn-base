package com.dxtwangxiao.strongestsuperscholar.web.util;

import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.JSONObject;
import com.dxtwangxiao.strongestsuperscholar.web.vo.RequestInfo;
import org.springframework.web.client.RestTemplate;

import javax.servlet.http.HttpServletRequest;
import java.io.BufferedReader;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.net.InetAddress;

/**
 * Created by Devin
 * 2018-06-28 下午 04:08
 */
public class WebUtil {

    private static RestTemplate restTemplate = new RestTemplate();

    public static RestTemplate getRestTemplate() {
        return restTemplate;
    }

    /**
     * 解析HTTP请求，获取RequestInfo实例
     *
     * @param request http请求
     * @return
     */
    public static RequestInfo parseRequest(HttpServletRequest request) {
        RequestInfo requestInfo = new RequestInfo();

        String reqId = request.getParameter("reqId");
        String reqType = request.getParameter("reqType");
        String reqUserInfo = request.getParameter("reqUserInfo");
        String reqParam = request.getParameter("reqParam");
        String pageInfo = request.getParameter("reqPageInfo");
        String reqRefData = request.getParameter("reqRefData");

        requestInfo.setReqId(reqId);
        requestInfo.setReqType(reqType);
        requestInfo.setReqUserInfo(JSONObject.parseObject(reqUserInfo));
        requestInfo.setReqParam(JSONObject.parseObject(reqParam));
        requestInfo.setReqPageInfo(JSONObject.parseObject(pageInfo));
        requestInfo.setReqRefData(JSONObject.parseObject(reqRefData));

        return requestInfo;
    }

    public static String getClientIp(HttpServletRequest request) {
        String clientIp = "";
        try {
            InetAddress inetAddress = InetAddress.getLocalHost();
            clientIp = inetAddress.getHostAddress();
        } catch (Exception e) {
            e.printStackTrace();
        }

        return clientIp;


//        String clientIp = request.getHeader("x-forwarded-for");
//        if (clientIp == null || clientIp.length() == 0 || "unknown".equalsIgnoreCase(clientIp)) {
//            clientIp = request.getHeader("Proxy-Client-IP");
//        }
//        if (clientIp == null || clientIp.length() == 0 || "unknown".equalsIgnoreCase(clientIp)) {
//            clientIp = request.getHeader("WL-Proxy-Client-IP");
//        }
//        if (clientIp == null || clientIp.length() == 0 || "unknown".equalsIgnoreCase(clientIp)) {
//            clientIp = request.getRemoteAddr();
//            if (clientIp.equals("127.0.0.1")) {
//                //根据网卡取本机配置的IP
//                InetAddress inetAddress = null;
//                try {
//                    inetAddress = InetAddress.getLocalHost();
//                } catch (Exception e) {
//                    e.printStackTrace();
//                }
//                clientIp = inetAddress.getHostAddress();
//            }
//        }
//        // 多个代理的情况，第一个IP为客户端真实IP,多个IP按照','分割
//        if (clientIp != null && clientIp.length() > 15) {
//            if (clientIp.indexOf(",") > 0) {
//                clientIp = clientIp.substring(0, clientIp.indexOf(","));
//            }
//        }
//
//        return clientIp;
    }
}
