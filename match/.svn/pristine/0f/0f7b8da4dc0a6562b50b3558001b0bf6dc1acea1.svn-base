import Vue from 'vue'
import Vuex from 'vuex'
import { api, testApi } from './config'
import { request, getUserInfo, login, createInnerAudioContext, getBackgroundAudioManager, navigateBack, showTip } from "./utils/wx";
import { RequestObj } from "./utils/RequestObj"



Vue.use(Vuex);

export default new Vuex.Store({
  state: {
    userInfo: {},
    userId: "",
    token: "",
    userGradeId: "",
    soundEffect: false,
    userGradePhaseId: "",
    music: false,
  },
  actions: {
    /**
         * 支付请求，包括统一下单和支付请求
         * @param commit 
         * @param productId
         * @returns {Promise<void>}
         */
    async pay({ commit, state }, productId) {

      //拿到后台统一支付结果
      const PreRes = await request({
        url: `${api}/recharge `,
        method: 'POST',
        data: new RequestObj({
          reqType: 'MAL_RNG_010_RechargeCoin',
          reqParam: {
            //openid: state.userInfo.openid,
            userId: state.userId,
            productId: productId,
            amount: 1
          }
        })
      });
      if (!PreRes.resResult.isSuccess) {
        await showToast({
          title: '支付请求失败',
          icon: 'success',
          duration: 2000
        });
        return;
      }

      //进行微信支付请求
      const PayRequestObj = await requestPayment({
        timeStamp: PreRes.resResult.curData.timeStamp,
        nonceStr: PreRes.resResult.curData.nonceStr,
        package: PreRes.resResult.curData.package,
        signType: PreRes.resResult.curData.signType,
        paySign: PreRes.resResult.curData.paySign,
        success: function (res) {
          // success
          console.log(res)
          navigateBack({
            delta: 1, // 回退前 delta(默认为1) 页面
            success: function (res) {
              showToast({
                title: '支付成功',
                icon: 'success',
                duration: 2000
              })
            },
          })
        },
        fail: function () {
          // fail
          console.log("支付失败");
          showToast({
            title: '支付失败',
            icon: 'none',
            duration: 2000,
          })
        },
        complete: function () {
          // complete
          console.log("支付完成")
        }
      });
    },


    /**
     * 金币购买学点请求
     * @param commit 
     * @param productId
     * @returns {Promise<void>}
     */
    async exchangeGold({ commit, state }, { productId, amount }) {
      const res = await request({
        url: `${testApi}/mall/productInfo/exchange`,
        method: 'POST',
        header: { 'content-type': 'application/json' },
        data: new RequestObj({
          reqType: 'MAL_CHG_010_ChangeLearningPoint',
          reqParam: {
            userId: state.userId,
            productId: productId,
            amount: amount
          }
        })
      });
      console.log(JSON.stringify(res));
      if (res.resResult.isSuccess) {
        state.userInfo.coin = res.resResult.curData.user.coin;
        state.userInfo.learningPoint = res.resResult.curData.user.learningPoint;
      }
      return res.resResult.isSuccess;
    },

    /** 
     * 开启背景音乐
     * @param commit
     * @param src
     * @returns {errorCode}
     */
    async startBackgroundMusic({ commit }, src) {
      console.log('111');
      const backgroundAudioManager = getBackgroundAudioManager();
      backgroundAudioManager.title = 'mus_001.wav';//必填
      backgroundAudioManager.src = src;
      //src='http://ws.stream.qqmusic.qq.com/M500001VfvsJ21xFqb.mp3?guid=ffffffff82def4af4b12b3cd9337d5e7&uin=346897220&vkey=6292F51E1E384E061FF02C31F716658E5C81F5594D561F2E88B854E81CAAB7806D5E4F103E55D33C16F3FAC506D1AB172DE8600B37E43FAD&fromtag=46'
    },

    /** 
     * 暂停背景音乐
     * @param commit
     * @param src
     * @returns {errorCode}
     */
    async pauseBackgroundMusic({ commit }) {
      console.log('222');
      const backgroundAudioManager = getBackgroundAudioManager();
      backgroundAudioManager.pause();
    },

    /** 
     * 停止背景音乐
     * @param commit
     * @param src
     * @returns {errorCode}
     */
    async stopBackgroundMusic({ commit }) {
      const backgroundAudioManager = getBackgroundAudioManager();
      backgroundAudioManager.stop();
    },



    /** 
     * 调用按钮声音
     * @param commit
     * @param src
     */
    async startInnerAudioContext({ commit }) {
      console.log('1111');
      const InnerAudioContext = createInnerAudioContext();
      console.log(InnerAudioContext);
      InnerAudioContext.src = "/static/musics/button_music.wav";
      //InnerAudioContext.src  = "/static/musics/BackgroundMusic_001.mp3";
      InnerAudioContext.volume = 1.0;
      console.log(InnerAudioContext.src);
      //InnerAudioContext.loop = true ;
      console.log(InnerAudioContext.duration);
      InnerAudioContext.play();

    },


    /** 
     * 关闭按钮声音
     * @param commit
     * @param src
     */
    async stopInnerAudioContext({ commit }) {
      const InnerAudioContext = createInnerAudioContext();
      InnerAudioContext.volume = 0;
    },

    /**
     * 获取年级类型列表
     * @param {*} param0 
     */
    async gradePhaseInfoList({ commit }) {
      let gradePhaseInfoList = [];
      //拿到类型列表
      const gradePhaseRes = await request({
        url: `${testApi}/base/gradePhaseInfo/list`,
        data: new RequestObj({
          reqType: 'INX_VWE_000_GetGradePhaseList',
          reqParam: {}
        })
      });
      //扩充类型列表，遍历并获取到每个类型对应的年级列表
      gradePhaseInfoList = gradePhaseRes.resResult.curData.gradePhaseInfoList;
      for (let i = 0; i < gradePhaseInfoList.length; ++i) {
        gradePhaseInfoList[i]['select'] = false;
        const gradeRes = await request({
          url: `${testApi}/base/gradeInfo/list/${gradePhaseInfoList[i].gradePhaseId}`,
          reqType: 'INX_VWE_000_GetGradeByGradePhaseId',
          reqParam: {}
        });
        gradePhaseInfoList[i]['gradeList'] = gradeRes.resResult.curData.gradeInfoList;
      }
      return gradePhaseInfoList;
    },

    /**
     * 获取登陆信息并保存在store中[首次登录,需提交用户信息至后台]
     * @param {*} param0 
     */
    async firstLogin({ commit, state }, { data }) {
      //拿到用户微信信息传递给后台创建用户
      const infoResult = await getUserInfo({
        withCredentials: false
      });
      const res = await request({
        url: `${testApi}/sys/user`,
        method: 'POST',
        header: { 'content-type': 'application/json' },
        data: new RequestObj({
          reqType: 'INX_VWE_000_CreateNewUser',
          reqParam: {
            nickName: infoResult.userInfo.nickName,
            avatarUrl: infoResult.userInfo.avatarUrl,
            gender: infoResult.userInfo.gender,
            city: infoResult.userInfo.city,
            gradePhaseId: data.gradePhaseId,
            gradeId: data.gradeId
          }
        })
      });
      // 将用户信息保存在全局
      state.userId = res.resResult.curData.user.userId;
      // 第一版暂时不用token
      // state.token = res.resResult.curData.token;
      state.userInfo = res.resResult.curData.user;

      //拿到用户登陆code传递给后台
      const logResult = await login();
      const result = await request({
        url: `${testApi}/sys/user/code`,
        method: 'POST',
        header: { 'content-type': 'application/json' },
        data: new RequestObj({
          reqType: 'SYS_PRE_000_SaveUserOpenId',
          reqParam: {
            userId: state.userId,
            code: logResult.code
          }
        }),
      });
    },

    /**
     * 获取登陆信息并保存在store中[非首次登陆，直接请求用户信息]
     * @param commit
     * @returns {Promise<void>}
     */
    async login({ commit, state }) {
      const logResult = await login();
      const res = await request({
        url: `${testApi}/sys/user/code`,
        data: new RequestObj({
          reqType: 'SYS_PRE_000_login',
          reqParam: { code: logResult.code }
        })
      });
      if (res.resResult.isSuccess) {
        state.userId = res.resResult.curData.user.userId;
        state.userInfo = res.resResult.curData.user;
      }
      return res.resResult.isSuccess;
    },

    /**
     * 获取好友对战/群pk战局信息
     * @param {*} param0 
     * @param {*} param1 
     */
    async createBattle({ commit, state }, { battleType }) {
      const res = await request({
        url: `${testApi}/match/pk`,
        method: 'POST',
        header: { 'content-type': 'application/json' },
        data: new RequestObj({
          reqType: 'SYS_MAT_001_createBattle',
          reqParam: {
            userId: state.userId,
            matchType: battleType
          }
        })
      });
      console.log("创建的战局信息是:" + JSON.stringify(res.resResult.curData.match));
      return res.resResult.curData.match.matchRecordId;
    },

    /**
     * 获取知识练兵场学科列表
     * @param {*} param0 
     */
    async getExerciseGradetList({ commit }) {
      const res = await request({
        url: `${testApi}/base/gradeInfo/list`,
        data: new RequestObj({
          reqType: 'MTH_EXC_010_GetGradeList',
          reqParam: {}
        })
      });
      return res.resResult.curData.gradeInfoList;
    },

    /**
         * 获取知识练兵场学科列表
         * @param {*} gradePhaseId 年级阶段id
         * * @param {*} gradeId 年级id
         */
    async getExercisesubjecttList({ commit }, { gradePhaseId, gradeId }) {
      const res = await request({
        url: `${testApi}/base/subject/list`,
        data: new RequestObj({
          reqType: 'MTH_EXC_010_GetGradeList',
          reqParam: {
            gradePhaseId: gradePhaseId,
            gradeId: gradeId
          }
        })
      });
      return res.resResult.curData.subjectList;
    },

    /**
     * 获取问题列表
     * @param commit
     * @param subjectId 学科id
     * @returns {Promise<*>}
     */
    async getExerciseMatchInfo({ commit }, { userId, subjectId }) {
      const res = await request({
        url: `${testApi}/match/exercise`,
        method: 'POST',
        header: { 'Content-Type': 'application/json' },
        data: new RequestObj({
          reqType: 'MTH_EXC_010_Exercise',
          reqParam: {
            userId: userId,
            subjectId: subjectId
          }
        }),
      });
      console.log(JSON.stringify(res));
      return res.resResult.curData;
    },

    /**
     * 根据知识练兵场结果更新用户信息
     * @param {*} param0 
     * @param {*} param1 
     */
    async SaveLpConsumeRecord({ commit }, { matchId, userId, questionIndex, userAnswer, amount, isTrue }) {

      const res = await request({
        url: `${testApi}/match/exercise/save`,
        //  url:`${api}/exercise`,
        method: 'POST',
        header: { 'content-type': 'application/json' },
        data: new RequestObj({
          reqType: 'MTH_EXC_010_Exercise',
          reqParam: {
            matchId: matchId,
            userId: userId,
            questionIndex: questionIndex,
            userAnswer: userAnswer,
            amount: amount,
            isTrue: isTrue
          }
        }),
      });
      console.log(amount + "调用了SaveLpConsumeRecord方法");
    },

    /**
     * 获取对抗赛结果信息
     * @param commit
     * @param state
     * @returns {Promise<*>}
     */
    async getResultInfo({ commit }, battleId) {
      const res = await request({
        url: `${api}/battleResult`,
        data: new RequestObj({
          reqType: 'SYS_PRE_000_getResultInfo',
          reqParam: { battleId: battleId }
        })
      });
      return res.resResult.curData.result;
    },

    /**
     *根据战局Id获取群比赛玩家列表
     * @param {*} param0 
     * @param {*} battleId 
     */
    async getPlayerListByBattleId({ commit }, battleId) {
      const res = await request({
        url: `${api}/groupBattle`,
        data: new RequestObj({
          reqType: 'SYS_PRE_000_GetPlyerListById',
          reqParam: { battleId: battleId }
        })
      });
      return res.playerList.resResult.curData.data;
    },

    /**
     * 获取商品列表（充值、金币商城）
     * @param {*} param0 
     * @param {*} paymentType 支付方式,0-充值,1-金币
     */
    async getProductList({ commit }, { paymentType }) {
      console.log('请求类型是：' + paymentType);
      const res = await request({
        url: `${testApi}/mall/productInfo/list`,
        data: new RequestObj({
          reqType: 'MAL_COM_010_GetProductList',
          reqParam: {
            paymentType: paymentType
          }
        })
      });
      console.log('拿到的商品列表是：' + JSON.stringify(res.resResult.curData.productList));
      return res.resResult.curData.productList;
    },

    // /**
    //  * 获取兑换页面的商品列表
    //  */
    // async getProductList({ commit }) {
    //   const res = await request({
    //     url: `${api}/topup`,
    //     data: new RequestObj({
    //       reqType: 'SYS_PRE_000_GetProductList',
    //       reqParam: {}
    //     })
    //   });
    //   return res.productList.resResult.curData.productList;
    // },

    /**
     * 获取金币商城页面商品列表
     * @param {*} param0 
     */
    async getProductListOfMall({ commit }) {
      const res = await request({
        url: `${api}/goldMall`,
        data: new RequestObj({
          reqType: 'SYS_PRE_000_GetProductListOfMall',
          reqParam: {}
        })
      });
      return res.productList.resResult.curData.data;
    },

    /**
     * 获取我的物品页面的物品列表
     * @param {*} param0 
     */
    async getProductListOfMine({ commit }) {
      const res = await request({
        url: `${api}/myItems`,
        data: new RequestObj({
          reqType: 'MAL_000_getProductListOfMine'
        })
      });
      return res.productList.resResult.curData.data;
    },

    /**
 * 获取奖学金页面的物品列表
 * @param {*} param0 
 */
    async getProductListOfScholarship({ commit }) {
      const res = await request({
        url: `${api}/scholarship`,
        data: new RequestObj({
          reqType: 'MAL_000_getProductListOfScholarship'
        })
      });
      return res.productList.resResult.curData.data;
    },

    /**
     * 获取排行榜界面好友排行
     * @param {*} param0 
     * @param {*} type 0-好友排行，1-全国排行 
     */
    async getRankList({ commit, state }) {
      const res = await request({
        url: `${testApi}/sys/rank/getWorldRank`,
        data: new RequestObj({
          reqType: 'SYS_RAN_010_getRankList',
          reqParam: { userId: state.userId }
        })
      });
      return res.resResult.curData;
    },

    /**
     * 获取用户的充值记录
     * @param {*} param0 
     */
    async getTopupRecords({ commit }) {
      const res = await request({
        url: `${api}/topupRecord`,
        data: new RequestObj({
          reqType: 'SYS_PRE_000_getTopupRecords',
          reqParam: {}
        })
      });
      return res.recordList.resResult.curData.data;
    },

    /**
     * 获取用户的兑换记录
     * @param {*} param0 
     */
    async getExchangeRecords({ commit }) {
      const res = await request({
        url: `${api}/exchangeRecords`,
        data: new RequestObj({
          reqType: 'SYS_PRE_000_getExchangeRecords',
          reqParam: {}
        })
      });
      return res.recordList.resResult.curData.data;
    },

    /**
     * 获取用户训练营信息
     * @param {*} param0 
     */
    async getMyCampInfo({ commit }) {
      const res = await request({
        url: `${api}/myCamp`,
        data: new RequestObj({
          reqType: 'SYS_PRE_000_getMyCampInfo',
          reqParam: {}
        })
      });
      return res.campInfo.resResult.curData.data;
    },

    /**
     * 保存对抗赛结果并更新用户信息
     * @param {*} param0 
     * @param {*} param1 
     */
    async saveBattleResult({ commit, state }, { matchId, userId, coin, gradePoint, learningPoint, experience, isWin }) {
      const res = await request({
        url: `${testApi}/match/save`,
        method: 'POST',
        header: { 'content-type': 'application/json' },
        data: new RequestObj({
          reqType: 'SYS_PRE_000_saveBattleResult',
          reqParam: {
            matchId: matchId,
            userId: userId,
            coin: coin,
            learningPoint: learningPoint,
            gradePoint: gradePoint,
            experience: experience,
            isWin: isWin
          }
        })
      });
      state.userInfo = res.resResult.curData;

    },

		/**
		 * 获取错题列表
		 * @param {*} param0
		 * @param {*} count 页面大小
		 * @param {*} page  页码
		 * 该接口已测试完成  --李沛昊
		 */
    async getQuestionList({ commit, state }, count, page) {
      const res = await request({
        url: `${testApi}/qst/errorQuestion/list`,
        data: new RequestObj({
          reqType: 'SYS_PER_080_GetErrorQuestionList',
          reqUserInfo: {
            userId: state.userId
          },
          reqParam: {
            userId: state.userId
          },
          pageInfo: {
            pageSize: count,
            curPage: page
          }
        })
      });
      return res.resResult.curData.errorMultipleQuestionList;
    },

		/**
		 * 收藏题目到题目收藏
		 * @param {*} param0
		 * @param {*} questionID 想添加到收藏的题目的id
		 * 该接口已测试完成  --李沛昊
		 */
    async collectQuestion({ commit, state }, questionID) {
      const res = await request({
        url: `${testApi}/qst/questionCollection`,
        method: 'POST',
        header: { 'content-type': 'application/json' },
        data: new RequestObj({
          reqType: 'SYS_PER_080_CollectQuestion',
          reqUserInfo: {
            userId: state.userId//"4dec9aed-01c8-4ea3-b480-aed46cf6694d"//state.userId
          },
          reqParam: {
            userId: state.userId,//"4dec9aed-01c8-4ea3-b480-aed46cf6694d",//state.userId,
            questionId: questionID
          }
        })
      });
      return res;
    },

    /**
     * 获取题目收藏
     * @param {*} param0
     * @param {*} count 页面大小
		 * @param {*} page  页码
		 * 该接口已测试完成  --李沛昊
     */
    async getCollectList({ commit, state }, count, page) {
      const res = await request({
        url: `${testApi}/qst/questionCollection/list`,
        data: new RequestObj({
          reqType: 'SYS_PER_080_GetCollectionsList',
          reqUserInfo: {
            userId: state.userId
          },
          reqParam: {
            userId: state.userId//'2893bc2d-74f6-4e5f-9f20-6c01e7e54aad'
          },
          pageInfo: {
            pageSize: count,
            curPage: page
          }
        })
      });
      return res.resResult.curData.questionList;
    },

    /**
     *  取消收藏
     * @param {*} param0
     * @param {*} questionCollectionID 取消收藏的题目的id
     * 该接口已测试完成  --李沛昊
     */
    async cancelCollection({ commit, state }, questionCollectionID) {
      const res = await request({
        url: `${testApi}/qst/questionCollection/cancel`,
        method: 'POST',
        header: { 'content-type': 'application/json' },
        data: new RequestObj({
          reqType: 'SYS_PER_080_CancelCollection',
          reqUserInfo: {
            userId: state.userId
          },
          reqParam: {
            questionCollectionId: questionCollectionID
          }
        })
      });
      return res;
    }
  },
})
